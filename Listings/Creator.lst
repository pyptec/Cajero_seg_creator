C51 COMPILER V9.59.0.0   CREATOR                                                           10/23/2019 15:46:26 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE CREATOR
OBJECT MODULE PLACED IN .\Objects\Creator.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Creator.C LARGE OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\List
                    -ings\Creator.lst) TABS(2) OBJECT(.\Objects\Creator.obj)

line level    source

   1          #include "creator.h"  
   2          
   3          void Eject_Card(unsigned char CodError) ;
   4          bit Send_Port(unsigned char NumChar);
   5          void Hex_Str(unsigned char valorhex);
   6          unsigned char two_one (unsigned char byte_h,unsigned char byte_l);
   7          void posee_in_out();
   8          void ve_id(unsigned char id_h,unsigned char id_l);
   9          unsigned char bcd_hex (unsigned char l_data);
  10          void Info_Retry(void);
  11          //***************************************************************************************************
  12          void sel_Pulsa(void)
  13          {
  14   1        sel_A=1;
  15   1        sel_B=1;
  16   1        sel_C=0;
  17   1      }
  18          //***************************************************************************************************
  19          void sel_Sensor2(void)
  20          {
  21   1        sel_A=0;
  22   1        sel_B=0;
  23   1        sel_C=1;
  24   1      }
  25          //***************************************************************************************************
  26          void sel_Sensor1(void)
  27          {
  28   1        sel_A=1;
  29   1        sel_B=0;
  30   1        sel_C=1;
  31   1      }
  32          //***************************************************************************************************
  33          //void sel_Dir1(void)
  34          //{
  35          //  sel_A=0;
  36          //  sel_B=1;
  37          //  sel_C=1;
  38          //}
  39          //***************************************************************************************************
  40          //void sel_Dir2(void)
  41          //{
  42          //  sel_A=1;
  43          //  sel_B=1;
  44          //  sel_C=1;
  45          //}                                                  
  46          
  47          void Ve_Hex(unsigned char valorhex)
  48          {
  49   1        unsigned char numero;
  50   1      
  51   1      
  52   1        decena=0;
  53   1        unidad=0;
  54   1        numero=valorhex;
C51 COMPILER V9.59.0.0   CREATOR                                                           10/23/2019 15:46:26 PAGE 2   

  55   1        numero=numero&0xf0;
  56   1        numero>>=4;
  57   1          decena=numero;
  58   1        (decena>0x09)?(decena=decena+0x37):(decena=decena+0x30);
  59   1        
  60   1        numero=valorhex;
  61   1        numero=numero&0x0f;
  62   1        unidad=numero;
  63   1        (unidad>0x09)?(unidad=unidad+0x37):(unidad=unidad+0x30);
  64   1      
  65   1      }
  66          
  67          //***************************************************************************************************
  68          
  69          
  70          //***************************************************************************************************
  71           
  72          //***************************************************************************************************
  73          //***************************************************************************************************
  74          //***************************************************************************************************
  75          //  CONVIERTE DE 1BYTE HEXADECIMAL A DECIMAL                            *
  76          //***************************************************************************************************
  77          void Hex_Str(unsigned char valorhex)
  78          {
  79   1        unsigned char numero;
  80   1      
  81   1        centena=0;
  82   1        decena=0;
  83   1        unidad=0;
  84   1        numero=valorhex;
  85   1      
  86   1        while (numero>=0x064)         // resto 100
  87   1        {
  88   2          numero=numero-0x64;
  89   2          centena=centena+1;
  90   2        }
  91   1        while (numero>=0x0a)        // resto 10
  92   1        {
  93   2          numero=numero-0x0a;
  94   2          decena=decena+1;
  95   2        }
  96   1        unidad=numero;
  97   1      
  98   1        decena=(decena|0x30);
  99   1        unidad=(unidad|0x30);
 100   1      }
 101          //***************************************************************************************************
 102          //***************************************************************************************************
 103          unsigned char two_one (unsigned char byte_h,unsigned char byte_l)
 104          {
 105   1      
 106   1        unsigned char byte_out;
 107   1      
 108   1        byte_h=byte_h&0x0f;
 109   1        byte_h<<=4;
 110   1        byte_l=byte_l&0x0f;
 111   1        byte_out=byte_h|byte_l;
 112   1      
 113   1        return byte_out;
 114   1      }
 115          //**************************************************************************************************
 116          //*******************************************************************************************
C51 COMPILER V9.59.0.0   CREATOR                                                           10/23/2019 15:46:26 PAGE 3   

 117          void ve_id(unsigned char id_h,unsigned char id_l)
 118          {
 119   1        unsigned int valor,numero;
 120   1        unsigned char dmil, mil, centena, decena, unidad;
 121   1        valor=0;
 122   1        dmil=0;
 123   1        mil=0;
 124   1        centena=0;
 125   1        decena=0;
 126   1        unidad=0;
 127   1      
 128   1      
 129   1         
 130   1        valor=id_h;
 131   1        valor<<=8;
 132   1        valor=valor|id_l;
 133   1      
 134   1      
 135   1        numero=valor;
 136   1        while (numero>=0x2710)        // resto 10.000 
 137   1        {
 138   2          numero=numero-0x2710;
 139   2          dmil=dmil+1;
 140   2        }
 141   1        while (numero>=0x03e8)        // resto 1.000
 142   1        {
 143   2          numero=numero-0x03e8;
 144   2          mil=mil+1;
 145   2        }
 146   1        while (numero>=0x064)         // resto 100
 147   1        {
 148   2          numero=numero-0x64;
 149   2          centena=centena+1;
 150   2        }
 151   1        while (numero>=0x0a)        // resto 10
 152   1        {
 153   2          numero=numero-0x0a;
 154   2          decena=decena+1;
 155   2        }
 156   1        unidad=numero;
 157   1      
 158   1      //  vdato(dmil|0x30);
 159   1      //  vdato(mil|0x30);
 160   1      //  vdato(centena|0x30);
 161   1      //  vdato(decena|0x30);
 162   1      //  vdato(unidad|0x30);
 163   1      
 164   1        if (dmil!=0)
 165   1        {
 166   2           buffer_ticket[num_data++]=(dmil|0x30);
 167   2           buffer_ticket[num_data++]=(mil|0x30);
 168   2           buffer_ticket[num_data++]=(centena|0x30);
 169   2           buffer_ticket[num_data++]=(decena|0x30);
 170   2           buffer_ticket[num_data++]=(unidad|0x30);
 171   2        }
 172   1        else if (mil!=0)
 173   1        {
 174   2           buffer_ticket[num_data++]=(mil|0x30);
 175   2           buffer_ticket[num_data++]=(centena|0x30);
 176   2           buffer_ticket[num_data++]=(decena|0x30);
 177   2           buffer_ticket[num_data++]=(unidad|0x30);
 178   2        }
C51 COMPILER V9.59.0.0   CREATOR                                                           10/23/2019 15:46:26 PAGE 4   

 179   1        else if (centena!=0)
 180   1        {
 181   2           buffer_ticket[num_data++]=(centena|0x30);
 182   2           buffer_ticket[num_data++]=(decena|0x30);
 183   2           buffer_ticket[num_data++]=(unidad|0x30);
 184   2        }
 185   1        else if (decena!=0)
 186   1        {
 187   2           buffer_ticket[num_data++]=(decena|0x30);
 188   2           buffer_ticket[num_data++]=(unidad|0x30);
 189   2        }
 190   1        else
 191   1        {
 192   2          buffer_ticket[num_data++]=(unidad|0x30);
 193   2        }
 194   1      
 195   1        
 196   1      }
 197          //******************************************************************************************
 198          //**************************************************************************************************
 199           unsigned char bcd_hex (unsigned char l_data)
 200           {
 201   1        unsigned char temp,j;
 202   1        temp=l_data;
 203   1        temp>>=4;
 204   1        temp=temp & 0x0f;
 205   1        if (temp!=0x00)
 206   1        {
 207   2          l_data=l_data & 0x0f;
 208   2          for (j=0;j<temp;j++)
 209   2          {
 210   3              l_data=l_data+0x0a;
 211   3          } 
 212   2        }
 213   1        return l_data;
 214   1       }
 215          
 216           /*----------------------------------------------------------------------------------------------------
 217              RECIBE INFORMACION DEL PROCESADOR PRINCIPAL POR P2      
 218          -----------------------------------------------------------------------------------------------------*/
 219          /*
 220          bit Send_Port(unsigned char NumChar)
 221          {
 222              unsigned char j; 
 223            long int cont;
 224            
 225            port_clk=1;             //El que transmite debe fijar primero el Clk en 1
 226            rx_in_data=0;           //Led de visualizacion  ON
 227            timeOut=0;
 228            ready=0;              //Genera interrupcion al Principal
 229            cont=50000;
 230            while ((busy==1)&&(timeOut==0))   //Espera reconocimiento INT por entrada busy
 231            {
 232              cont--;
 233              if (cont==0)
 234              {
 235                timeOut=1;
 236              }
 237            }
 238            if ((timeOut==0)&&(busy==0))
 239            {
 240              for (j=0; j<NumChar; j++)
C51 COMPILER V9.59.0.0   CREATOR                                                           10/23/2019 15:46:26 PAGE 5   

 241              {
 242                P2=buffer_ticket[j];
 243                port_clk=0;
 244                wait_long();
 245                port_clk=1;
 246                wait_long();
 247              }
 248            }
 249            //P2=0XFF;
 250            ready=1;
 251            port_clk=1;
 252            rx_in_data=1;         //Led de visualizacion  OFF
 253            //wait_long();  
 254          
 255            return timeOut;
 256          }
 257          
 258          
 259          //********************************************************************************************************
             -***
 260          //********************************************************************************************************
             -***
 261          //  COMANDOS MIFARE TYRM 9000                                       *
 262          //********************************************************************************************************
             -***
 263          //********************************************************************************************************
             -***
 264          
 265          
 266          //********************************************************************************************************
             -***
 267          //********************************************************************************************************
             -***
 268          /*ojo jp
 269          void LuzCajero (unsigned char CodLuz)  
 270          {
 271                
 272            buffer_ticket[0]=STX;
 273            buffer_ticket[1]='0';
 274            buffer_ticket[2]=0X03;
 275            buffer_ticket[3]='L';
 276            buffer_ticket[4]=CodLuz;
 277            buffer_ticket[5]=ETX;
 278            Send_Port(6);
 279          
 280          }
 281          */
 282          //--------------------------------------------------------------------
 283          //********************************************************************************************************
             -***
 284          void Eject_Card(unsigned char CodError)  
 285          {
 286   1            
 287   1        if ((CodError!=SIN_ERROR)&&(CodError!=ERR_EJECT)&&(CodError!=DESARM))      
 288   1        {
 289   2          buffer_ticket[0]=STX;
 290   2          buffer_ticket[1]='0';
 291   2          buffer_ticket[2]=0X06;
 292   2          buffer_ticket[3]='e';
 293   2          buffer_ticket[4]=CodError;
 294   2          buffer_ticket[5]=ETX;
 295   2          Send_Port(6);
C51 COMPILER V9.59.0.0   CREATOR                                                           10/23/2019 15:46:26 PAGE 6   

 296   2        }
 297   1      //--------------------------------------------------------------------
 298   1      //  COMANDO EXPULSION
 299   1      //--------------------------------------------------------------------
 300   1       eject_card ();
 301   1      }
 302          
 303          //********************************************************************************************************
             -***
 304          //********************************************************************************************************
             -***
 305          
 306          //********************************************************************************************************
             -***********************
 307          void Info_Retry(void)
 308          {
 309   1      //  sel_com=PuertoMF;
 310   1      //  tx_chr('R');
 311   1      //  tx_chr('E');
 312   1      //  tx_chr('T');
 313   1      //  tx_chr('R');
 314   1      //  tx_chr('Y');
 315   1      //  tx_chr(CR);
 316   1      //  tx_chr(LF);
 317   1      //  while (sendactive==1) 
 318   1      //  {
 319   1      //  }
 320   1      //  sel_com=PuertoDB9;
 321   1      
 322   1        tx_aux('R');
 323   1        tx_aux('E');
 324   1        tx_aux('I');
 325   1        tx_aux('N');
 326   1        tx_aux('T');
 327   1        tx_aux('E');
 328   1        tx_aux('N');
 329   1        tx_aux('T');
 330   1        tx_aux('O');
 331   1        tx_aux(':');
 332   1        tx_aux(RetryWR|0x30);
 333   1        tx_aux(CR);
 334   1        tx_aux(LF);
 335   1      }
 336          void posee_in_out()
 337          {
 338   1       Debug_txt_Tibbo((unsigned char *) "POSEE IN\r\n");
 339   1      
 340   1        Hex_Str(g_scArrRxComSoft[8]);       // Año Entrada
 341   1        g_scDATE[0]=decena;
 342   1        g_scDATE[1]=unidad;
 343   1                      
 344   1        Hex_Str(g_scArrRxComSoft[9]);       // Mes Entrada
 345   1        g_scDATE[2]=decena;
 346   1        g_scDATE[3]=unidad;
 347   1                      
 348   1        Hex_Str(g_scArrRxComSoft[10]);      // Dia Entrada
 349   1        g_scDATE[4]=decena;
 350   1        g_scDATE[5]=unidad;
 351   1                      
 352   1        Hex_Str(g_scArrRxComSoft[11]);      // Hora Entrada
 353   1        g_scDATE[6]=decena;
 354   1        g_scDATE[7]=unidad;
C51 COMPILER V9.59.0.0   CREATOR                                                           10/23/2019 15:46:26 PAGE 7   

 355   1                                    
 356   1        Hex_Str(g_scArrRxComSoft[12]);      // Minuto Entrada
 357   1        g_scDATE[8]=decena;
 358   1        g_scDATE[9]=unidad;
 359   1        
 360   1        Cod_Dcto=two_one(g_scArrRxComSoft[15],g_scArrRxComSoft[14]);
 361   1        Cod_Dcto=Cod_Dcto+0x30;
 362   1                      
 363   1        Debug_txt_Tibbo((unsigned char *) "DCTO:");
 364   1        tx_aux(Cod_Dcto);
 365   1        tx_aux(CR);
 366   1        tx_aux(LF);
 367   1      
 368   1      //------------------------------------------------------------------------------------------------
 369   1        TipoVeh=g_scArrRxComSoft[16]&(0x0f);
 370   1        Val_Horario=g_scArrRxComSoft[16]&(0xf0);
 371   1        Val_Horario>>=4;
 372   1      //------------------------------------------------------------------------------------------------
 373   1        if ((TipoCard==CARD_MENSUALIDAD)||(TipoCard==CARD_COMPARTIDA))
 374   1          {
 375   2            Val_PicoPlaca=g_scArrRxComSoft[17]&0xf0;
 376   2            Val_PicoPlaca>>=4;
 377   2            ValDCTO_INPAGO=g_scArrRxComSoft[17]&0x0F;
 378   2          }
 379   1          else
 380   1            {
 381   2              ValDCTO_INPAGO=g_scArrRxComSoft[17];
 382   2            }
 383   1      
 384   1              APB_CARD=g_scArrRxComSoft[18];
 385   1      //------------------------------------------------------------------------------------------------
 386   1            Hex_Str(g_scArrRxComSoft[19]);      // Año Liquidacion + T gracia
 387   1            g_scDATE_Liq[0]=decena;
 388   1            g_scDATE_Liq[1]=unidad;
 389   1                      
 390   1            Hex_Str(g_scArrRxComSoft[20]);      // Mes Liquidacion + T gracia
 391   1            g_scDATE_Liq[2]=decena;
 392   1            g_scDATE_Liq[3]=unidad;
 393   1                      
 394   1            Hex_Str(g_scArrRxComSoft[21]);      // Dia Liquidacion + T gracia
 395   1            g_scDATE_Liq[4]=decena;
 396   1            g_scDATE_Liq[5]=unidad;
 397   1                    
 398   1            Hex_Str(g_scArrRxComSoft[22]);      // Hora Liquidacion + T gracia
 399   1            g_scDATE_Liq[6]=decena;
 400   1            g_scDATE_Liq[7]=unidad;
 401   1                
 402   1            Hex_Str(g_scArrRxComSoft[23]);      // Minuto Liquidacion + T gracia
 403   1            g_scDATE_Liq[8]=decena;
 404   1            g_scDATE_Liq[9]=unidad;
 405   1      //------------------------------------------------------------------------------------------------                
 406   1                              
 407   1            Lea_S1_Block(0);                  /* lee el bloque 0 de la tarjeta MF50 */
 408   1            ValTimeOutCom=TIMWPoll;
 409   1            buffer_ready=0;
 410   1            g_cEstadoComSoft=ESPERA_RX;
 411   1            g_cEstadoComSeqMF=SEQ_RTA_rdB4;
 412   1      }     
 413          
 414          
 415          //*******************************************************************************************
 416          
C51 COMPILER V9.59.0.0   CREATOR                                                           10/23/2019 15:46:26 PAGE 8   

 417          //*******************************************************************************************
 418          //*******************************************************************************************
 419          //                                              *
 420          //      CICLO DE EvP (SECUENCIA VEHICULAR IMPRESION/LECTURA               *
 421          //                                              *
 422          //*******************************************************************************************
 423          
 424          
 425          //******************************************************************************************* 
 426          //  PROGRAMA PRINCIPAL                                    *
 427          //*******************************************************************************************
 428          //*******************************************************************************************
 429          void main (void)  
 430          {
 431   1        unsigned int k;
 432   1      
 433   1      //******************************************************************************************* 
 434   1        TF2=0;                //  Bandera de Timer                *
 435   1        TH2=0X00;             //                          *           
 436   1        TL2=0X00;             //                          *
 437   1        TR2=1;                // Run Timer 0                    *
 438   1      //******************************************************************************************* 
 439   1          EA = 1;                             // Enable global interrupts             *
 440   1          com_initialize ();                  // Initialize interrupt driven serial I/O       *
 441   1      //******************************************************************************************* 
 442   1        TMOD=(TMOD & 0xf0) | 0x01;      //  Coloca el temporizador 0 y 1 en modo 1.  16bITS *
 443   1        TF0=0;                //  Bandera de Timer                *
 444   1        TH0=0X00;             //                          *           
 445   1        TL0=0X00;             //                          *
 446   1        TR0=1;                // Run TM2                      *
 447   1      //******************************************************************************************* 
 448   1      //*******************************************************************************************
 449   1        onceAlarm=0;
 450   1      //*******************************************************************************************
 451   1        led_err=1;              // Error Impresora                  *
 452   1        rx_in_data = 1;           // Indicador de Rx Transporte o Lectura Wiegand   * 
 453   1        lock=0;               // Relevo 0                     *
 454   1        Atascado = 0;           //
 455   1      //------------------------------------------------------------------------------------------*
 456   1        seg=CTE_SEG;            //                          *
 457   1        txd2=1;                 //                          *
 458   1        sel_com=PuertoDB9;          //                          *
 459   1        g_cCodSeqMF='0';          //                          *
 460   1      //*******************************************************************************************
 461   1        Eject_Card(SIN_ERROR);
 462   1      //------------------------------------------------------------------------------------------*
 463   1      //  Antena_OFF();
 464   1      //  for (k=0;k<5000;k++)
 465   1      //  {
 466   1      //    wait_long();
 467   1      //  }
 468   1      //------------------------------------------------------------------------------------------* 
 469   1          ErrorWR_CARD=0;
 470   1        buffer_ready=0;
 471   1        FueraServicio=0;
 472   1        RetryWR=0;
 473   1        GrabaTarjeta=0;
 474   1      //------------------------------------------------------------------------------------------*
 475   1        g_cEstadoComSoft=ESPERA_RX;
 476   1        g_cEstadoComSeqMF=SEQ_INICIO;
 477   1        ValTimeOutCom=TIMWPoll;       //                          *
 478   1        TIME_ESPERA=0;
C51 COMPILER V9.59.0.0   CREATOR                                                           10/23/2019 15:46:26 PAGE 9   

 479   1      
 480   1        for (k=0; k<60; k++)
 481   1        {
 482   2          buffer_ticket[k]=0;
 483   2        }
 484   1      //*******************************************************************************************
 485   1      //      LOOP PRINCIPAL                                  *
 486   1      //*******************************************************************************************
 487   1        MultiPark=0;
 488   1        PrintLPR=1;
 489   1      //*******************************************************************************************
 490   1        Debug_txt_Tibbo((unsigned char *) "inicio debug jp\r\n"); 
 491   1        Debug_Dividir_texto();
 492   1        while (1)                 // Loop Principal               * 
 493   1        {                                 
 494   2      //------------------------------------------------------------------------------------------*
 495   2          P2=0xff;
 496   2          cod_alarm=P2;
 497   2          txd2=1;
 498   2      //------------------------------------------------------------------------------------------*
 499   2          ProcesoLector();
 500   2      //------------------------------------------------------------------------------------------* 
 501   2        
 502   2      //------------------------------------------------------------------------------------------*
 503   2      //------------------------------------------------------------------------------------------*
 504   2          if(TF0==1)
 505   2          {
 506   3            TF0=0;
 507   3       
 508   3      //--------------------------------------------------------- 
 509   3              if (ValTimeOutCom!=0)
 510   3            {
 511   4              ValTimeOutCom--;
 512   4              if (TxENQ==1)
 513   4              {
 514   5                tx_chr(ENQ);
 515   5                TxENQ=0;
 516   5                ValTimeOutCom=TIMWPoll;
 517   5                g_cEstadoComSoft=ESPERA_INICIO_RTA;
 518   5              }
 519   4              
 520   4            }
 521   3      //---------------------------------------------------------
 522   3            if (TIME_ESPERA!=0)
 523   3            {
 524   4              TIME_ESPERA--;
 525   4            }
 526   3      //---------------------------------------------------------
 527   3            seg--;
 528   3            if (seg==0)
 529   3            {
 530   4      
 531   4                    if (((alarma1==1)||(alarma2==1)||(alarma3==1))&&(onceAlarm==0))
 532   4                {
 533   5                  onceAlarm=1;
 534   5              
 535   5                  cod_alarm=0x30;
 536   5                  if (alarma1==1)
 537   5                  {
 538   6                    cod_alarm++;
 539   6                    AlarmaPrevia1=1;
 540   6                  }
C51 COMPILER V9.59.0.0   CREATOR                                                           10/23/2019 15:46:26 PAGE 10  

 541   5                  if (alarma2==1)
 542   5                  {
 543   6                    cod_alarm++;
 544   6                    cod_alarm++;
 545   6                    AlarmaPrevia2=1;  
 546   6                  }
 547   5                  if (alarma3==1)
 548   5                  {
 549   6                    cod_alarm++;
 550   6                    cod_alarm++;
 551   6                    cod_alarm++;
 552   6                    cod_alarm++;
 553   6                    AlarmaPrevia3=1;
 554   6                  }                   
 555   5                  
 556   5        
 557   5        
 558   5        
 559   5                  buffer_ticket[0]=STX;
 560   5                  buffer_ticket[1]='0';
 561   5                  buffer_ticket[2]=0X06;
 562   5                  buffer_ticket[3]='A';
 563   5                  buffer_ticket[4]=cod_alarm;
 564   5                  buffer_ticket[5]=ETX;
 565   5                  Send_Port(6);
 566   5                }
 567   4      
 568   4      
 569   4      
 570   4         
 571   4              seg=CTE_SEG;
 572   4                if (blink==0)
 573   4              {
 574   5                led_err=1;
 575   5                blink=1;
 576   5              }
 577   4              else
 578   4              {
 579   5                led_err=0;
 580   5                blink=0;
 581   5              }
 582   4      //        lock=0;
 583   4      //------------------------------------------------------------------------------------------*
 584   4      //        iData=TABLE_CRC16_R[j];
 585   4      //        tx_chr2bytes(iData);
 586   4      //        j++;
 587   4      //------------------------------------------------------------------------------------------*
 588   4            }
 589   3          }                     // if(TF0==1)
 590   2      //------------------------------------------------------------------------------------------*
 591   2      //    sel_Funcion();
 592   2      //    if ((DataIn==0)&&(info==0))
 593   2      //    {
 594   2      //      if (busy==1)
 595   2      //      {
 596   2      //        info=1;
 597   2      //        rx_in_data=0;
 598   2      //        load_info();
 599   2      //        send_info();
 600   2      //        rx_in_data=1;
 601   2      //      }
 602   2      //    }
C51 COMPILER V9.59.0.0   CREATOR                                                           10/23/2019 15:46:26 PAGE 11  

 603   2      //    sel_Funcion();
 604   2      //    if (DataIn==1)
 605   2      //    {
 606   2      //      info=0;
 607   2      //    }
 608   2      //------------------------------------------------------------------------------------------*
 609   2      //    sel_Sensor1();
 610   2      //    if (DataIn==0)
 611   2      //    {
 612   2      //    }
 613   2      //    sel_Sensor2();
 614   2      //    if (DataIn==0)
 615   2      //    {
 616   2      //    }
 617   2      //-------------------------------------------------------------------------------------------*
 618   2      /////////////////////////////////////////////////////////////////////////////////////////////
 619   2      
 620   2          if ((g_cEstadoComSeqMF!=SEQ_WCMD)&&(g_cEstadoComSeqMF!=SEQ_RTA_STATUSout)&&(Expulsa_Grabacion==0))
 621   2          {
 622   3            if (busy==0)
 623   3            {
 624   4                recibe_port();
 625   4              if (buffer_ticket[3]=='O')
 626   4              {
 627   5      
 628   5                Eject_Card(CARD_EJECT);
 629   5      
 630   5                if (num_data==5)
 631   5                {
 632   6      //            Eject_Card(CARD_EJECT);
 633   6      
 634   6                }
 635   5                else if (num_data==16)
 636   5                {
 637   6      //-------------------------------------------------------------------------------------------*
 638   6                    tx_aux('S');
 639   6                    tx_aux('I');
 640   6                    tx_aux('N');
 641   6                    tx_aux(' ');
 642   6                    tx_aux('T');
 643   6                    tx_aux('A');
 644   6                    tx_aux('R');
 645   6                    tx_aux('J');
 646   6                    tx_aux('E');
 647   6                    tx_aux('T');
 648   6                    tx_aux('A');
 649   6                    tx_aux(' ');
 650   6      
 651   6      
 652   6      
 653   6                    tx_aux('P');
 654   6                    tx_aux('C');
 655   6                    tx_aux(':');
 656   6                    for (k=0; k<16; k++)
 657   6                    {
 658   7                      tx_aux(buffer_ticket[k]); 
 659   7                    }
 660   6                    tx_aux(CR);
 661   6                    tx_aux(LF);
 662   6      //-------------------------------------------------------------------------------------------*            
 663   6                }
 664   5        
C51 COMPILER V9.59.0.0   CREATOR                                                           10/23/2019 15:46:26 PAGE 12  

 665   5              }
 666   4              else if (buffer_ticket[3]=='o')
 667   4              {
 668   5                GrabaTarjeta=0;
 669   5                Desarmado=0;
 670   5                Permite_Puerta=0;
 671   5                Permite_Billetero=0;
 672   5                Permite_Monedero=0;
 673   5                NotifyCofreCoin=0;
 674   5                NotifyCofreB2B=0;
 675   5                NotifyPuerta=0;
 676   5                }
 677   4              else if (buffer_ticket[3]=='F')
 678   4              {
 679   5                FueraServicio=1;
 680   5                }
 681   4              else if (buffer_ticket[3]=='E')
 682   4              {
 683   5                FueraServicio=0;
 684   5                AlarmaPrevia1=0;
 685   5                AlarmaPrevia2=0;
 686   5                AlarmaPrevia3=0;
 687   5                GrabaTarjeta=0;
 688   5                Desarmado=0;
 689   5                lock=0;
 690   5                onceAlarm=0;
 691   5                alarma1=0;
 692   5                alarma2=0;
 693   5                alarma3=0;
 694   5                Permite_Puerta=0;
 695   5                Permite_Billetero=0;
 696   5                Permite_Monedero=0;
 697   5                NotifyCofreCoin=0;
 698   5                NotifyCofreB2B=0;
 699   5                NotifyPuerta=0;
 700   5                }
 701   4      
 702   4              else if (buffer_ticket[3]=='?')
 703   4              {
 704   5                buffer_ticket[0]=STX;
 705   5                buffer_ticket[1]='0';
 706   5                buffer_ticket[2]=0X06;
 707   5                buffer_ticket[3]='e';
 708   5                buffer_ticket[4]=0x40;        //Tarjeta Mal Insertada
 709   5                buffer_ticket[5]=ETX;
 710   5                Send_Port(6);     
 711   5                }
 712   4            }         
 713   3          }
 714   2                                       
 715   2                                                     
 716   2      /////////////////////////////////////////////////////////////////////////////////////////////
 717   2      //*******************************************************************************************
 718   2      //      ALARMAS
 719   2      //*******************************************************************************************
 720   2      //    sel_Sensor1();
 721   2      //    if ((DataIn==1)&&(Permite_Puerta==0))
 722   2      //    {
 723   2      //      lock=1;
 724   2      //      alarma1=1;
 725   2      //    }
 726   2      //-------------------------------------------------------
C51 COMPILER V9.59.0.0   CREATOR                                                           10/23/2019 15:46:26 PAGE 13  

 727   2          Tmin=2500;
 728   2          Activo=0;
 729   2          sel_Sensor1();
 730   2          if (DataIn==1)
 731   2          {
 732   3            sel_Sensor1();
 733   3            if (DataIn==1)
 734   3            {
 735   4              while ((DataIn==1)&&(Activo==0))
 736   4              {
 737   5                Tmin--;
 738   5                if (Tmin==0)
 739   5                {
 740   6                  Activo=1;
 741   6                }
 742   5      
 743   5              }
 744   4              if ((Activo==1)&&(Permite_Puerta==0))
 745   4              {
 746   5                lock=1;
 747   5                alarma1=1;
 748   5              }
 749   4            }
 750   3          }
 751   2      //-------------------------------------------------------
 752   2      //    sel_Sensor2();
 753   2      //    if ((DataIn==1)&&(Permite_Billetero==0))
 754   2      //    {
 755   2      //      lock=1;
 756   2      //      alarma2=1;
 757   2      //    }
 758   2      //--------------------------------------------------------
 759   2          Tmin=2500;
 760   2          Activo=0;
 761   2          sel_Sensor2();
 762   2          if (DataIn==1)
 763   2          {
 764   3            sel_Sensor2();
 765   3            if (DataIn==1)
 766   3            {
 767   4              while ((DataIn==1)&&(Activo==0))
 768   4              {
 769   5                Tmin--;
 770   5                if (Tmin==0)
 771   5                {
 772   6                  Activo=1;
 773   6                }
 774   5              }
 775   4              if ((Activo==1)&&(Permite_Billetero==0))
 776   4              {
 777   5                lock=1;
 778   5                alarma2=1;
 779   5              }
 780   4            }
 781   3          }
 782   2      //*********************************************************
 783   2      //    sel_Pulsa();
 784   2      //    if ((DataIn==1)&&(Permite_Monedero==0))
 785   2      //    {
 786   2      //      lock=1;
 787   2      //      alarma3=1;
 788   2      //    }
C51 COMPILER V9.59.0.0   CREATOR                                                           10/23/2019 15:46:26 PAGE 14  

 789   2      //---------------------------------------------------------
 790   2          Tmin=2500;
 791   2          Activo=0;
 792   2          sel_Pulsa();
 793   2          if (DataIn==1)
 794   2          {
 795   3            sel_Pulsa();
 796   3            if (DataIn==1)
 797   3            {
 798   4              while ((DataIn==1)&&(Activo==0))
 799   4              {
 800   5                Tmin--;
 801   5                if (Tmin==0)
 802   5                {
 803   6                  Activo=1;
 804   6                }
 805   5              }
 806   4              if ((Activo==1)&&(Permite_Monedero==0))
 807   4              {
 808   5                lock=1;
 809   5                alarma3=1;
 810   5              }
 811   4            }
 812   3          }
 813   2      //********************************************************        
 814   2      
 815   2          if ((Permite_Puerta==1)&&(Permite_Billetero==1)&&(Permite_Monedero==1))
 816   2          {
 817   3            lock=0;
 818   3            onceAlarm=0;
 819   3            alarma1=0;
 820   3            alarma2=0;
 821   3            alarma3=0;
 822   3          }
 823   2        
 824   2      //*******************************************************************************************
 825   2      //    Notificacion de Aperturas en Desarmado
 826   2      //*******************************************************************************************
 827   2          if ((Desarmado==1))
 828   2          {
 829   3            sel_Sensor1();
 830   3            if ((DataIn==1)&&(NotifyPuerta==0)&&(AlarmaPrevia1==0))
 831   3            {
 832   4              NotifyPuerta=1;
 833   4      
 834   4              buffer_ticket[0]=STX;
 835   4              buffer_ticket[1]='0';
 836   4              buffer_ticket[2]=0X06;
 837   4              buffer_ticket[3]='S';
 838   4              buffer_ticket[4]='1';
 839   4              buffer_ticket[5]=ETX;
 840   4              Send_Port(6);
 841   4       
 842   4            }
 843   3            
 844   3            sel_Sensor2();
 845   3            if ((DataIn==1)&&(NotifyCofreB2B==0)&&(AlarmaPrevia2==0))
 846   3            {
 847   4              NotifyCofreB2B=1;
 848   4      
 849   4              buffer_ticket[0]=STX;
 850   4              buffer_ticket[1]='0';
C51 COMPILER V9.59.0.0   CREATOR                                                           10/23/2019 15:46:26 PAGE 15  

 851   4              buffer_ticket[2]=0X06;
 852   4              buffer_ticket[3]='S';
 853   4              buffer_ticket[4]='2';
 854   4              buffer_ticket[5]=ETX;
 855   4              Send_Port(6);
 856   4            }           
 857   3      
 858   3            sel_Pulsa();
 859   3            if ((DataIn==1)&&(NotifyCofreCoin==0)&&(AlarmaPrevia3==0))
 860   3            {
 861   4              NotifyCofreCoin=1;
 862   4      
 863   4              buffer_ticket[0]=STX;
 864   4              buffer_ticket[1]='0';
 865   4              buffer_ticket[2]=0X06;
 866   4              buffer_ticket[3]='S';
 867   4              buffer_ticket[4]='3';
 868   4              buffer_ticket[5]=ETX;
 869   4              Send_Port(6);
 870   4            }
 871   3      
 872   3            }
 873   2      /////////////////////////////////////////////////////////////////////////////////////////////
 874   2      //------------------------------------------------------------------------------------------*
 875   2      //    if(TF2==1)
 876   2      //    {
 877   2      //      TF2=0;
 878   2      //        seg2--;
 879   2      //      if (seg2==0)
 880   2      //      {
 881   2      //        seg2=CTE_SEG;
 882   2      //      }
 883   2      //    }
 884   2      //------------------------------------------------------------------------------------------*
 885   2          }                       //Cierra While Principal        * 
 886   1      }                         //Cierra main             *
 887          //*******************************************************************************************
 888          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2054    ----
   CONSTANT SIZE    =     35    ----
   XDATA SIZE       =    305       5
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =     35    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
